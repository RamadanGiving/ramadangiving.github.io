# Continuous Integration - runs on every PR
name: CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  # ===========================================
  # Code Quality Checks
  # ===========================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Lint code
        run: npm run lint

      - name: ðŸ” Type check
        run: npx tsc --noEmit

  # ===========================================
  # Build Verification
  # ===========================================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ“ Generate posts
        run: npm run posts

      - name: ðŸ—ï¸ Build
        run: npm run build

      - name: ðŸ“Š Check bundle size
        run: |
          echo "## ðŸ“¦ Build Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_SIZE=$(du -sh out | cut -f1)
          HTML_COUNT=$(find out -name "*.html" | wc -l)
          JS_SIZE=$(find out -name "*.js" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          CSS_SIZE=$(find out -name "*.css" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          
          echo "| Total | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Pages | $HTML_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | $JS_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | $CSS_SIZE |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Content Validation
  # ===========================================
  content:
    name: Content Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ“ Validate blog posts
        run: |
          echo "## ðŸ“ Blog Posts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm run posts
          
          # Count posts
          POST_COUNT=$(find content/posts -name "*.md" ! -name "_*" | wc -l)
          echo "Total posts: $POST_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ–¼ï¸ Check for large images
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ–¼ï¸ Large Images (>500KB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          find public/assets -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -size +500k -exec ls -lh {} \; | \
          awk '{print "- " $NF " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "None found âœ…" >> $GITHUB_STEP_SUMMARY

