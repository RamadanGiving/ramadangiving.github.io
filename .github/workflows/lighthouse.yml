# Lighthouse CI workflow - runs on deployed site
name: Lighthouse Audit

on:
  # Run after deployment completes
  workflow_run:
    workflows: ["Build & Deploy to GitHub Pages"]
    types:
      - completed
  # Manual trigger
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to audit'
        required: false
        default: 'https://ramadangiving.github.io'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â³ Wait for deployment to propagate
        run: sleep 30

      - name: ğŸ”¦ Run Lighthouse on live site
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://ramadangiving.github.io/
            https://ramadangiving.github.io/donate/
            https://ramadangiving.github.io/blog/
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ğŸ“Š Format Lighthouse results
        uses: actions/github-script@v7
        with:
          script: |
            const links = ${{ steps.lighthouse.outputs.links }};
            const assertionResults = ${{ steps.lighthouse.outputs.assertionResults }};
            
            let comment = '## ğŸ”¦ Lighthouse Report\n\n';
            comment += '| URL | Performance | Accessibility | Best Practices | SEO |\n';
            comment += '|-----|-------------|---------------|----------------|-----|\n';
            
            // Note: This is a simplified example
            // Actual implementation would parse the results
            
            comment += '\n\nğŸ“Š [View Full Report](' + Object.values(links)[0] + ')';
            
            console.log(comment);

      - name: ğŸ“¤ Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: '.lighthouseci'
          retention-days: 30

